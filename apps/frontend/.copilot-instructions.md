# OSM — Frontend Agent

## Role

You are the **Frontend Agent**. You own `apps/frontend` — the Vue 3 + Vite SPA (React 18 is the alternate) that is the back-office interface for OSM. You consume the tRPC `AppRouter` type from `@osm/api` (type-only) and call procedures via the tRPC client. You never import runtime code from `apps/backend`.

---

## App Info

```
Framework:      Vue 3 + Vite (React 18 + Vite is the alternate)
State:          Pinia (Zustand for React)
Server state:   TanStack Query (vue-query or react-query) + tRPC
Forms:          vee-validate + Zod (react-hook-form + Zod for React)
UI:             shadcn/vue or Vuetify 3 (shadcn/ui or MUI v5 for React)
Dates:          date-fns
Tests:          Vitest + Vue Testing Library
Build:          Vite
Package:        @osm/frontend
Depends on:     @osm/api (type-only)
Language:       PT-BR for all labels, copy, and domain terms
```

---

## Directory Structure

```
apps/frontend/src/
├── lib/
│   ├── trpc.ts              ← tRPC client setup (createTRPCProxyClient)
│   └── auth.ts              ← getAccessToken(), logout(), isTokenExpired()
├── store/
│   ├── auth.store.ts        ← AuthState: token, userInfo, userResources, isLoading
│   ├── config.store.ts      ← ConfigsList from lista.all (localStorage cache, 30min TTL)
│   └── ui.store.ts          ← global loading, modal, toast state
├── router/
│   ├── index.ts             ← route definitions with meta.permission
│   └── guards.ts            ← beforeEach: JWT check → permission check → navigate
├── pages/
│   ├── auth/
│   │   ├── LoginCallbackPage.vue   ← /login — extracts token from query params
│   │   └── SignInPage.vue          ← /sign-in — Okta login button
│   ├── modelos/
│   │   ├── DashboardPage.vue       ← /modelos/dashboard — TELA_DASHBOARD
│   │   ├── InventarioPage.vue      ← /modelos/inventario — TELA_CONSULTA_MODELO
│   │   ├── CadastroPage.vue        ← /modelos/cadastro
│   │   ├── EditarPage.vue          ← /modelos/editar/:id
│   │   └── VisualizarPage.vue      ← /modelos/visualizar/:id
│   ├── historico/
│   ├── categorias/
│   ├── baldes/
│   ├── showroom/
│   ├── perfis/
│   ├── recursos/
│   └── admin/
│       ├── AdminLayout.vue          ← dedicated sidebar layout for /admin
│       ├── DashboardPage.vue        ← /admin
│       ├── usuarios/
│       ├── convites/
│       ├── perfis/
│       ├── recursos/
│       ├── entidades/
│       ├── showroom/
│       ├── analytics/
│       └── auditoria/
├── components/
│   ├── layout/
│   │   ├── AppHeader.vue
│   │   ├── NavMenu.vue             ← driven by NAV_MENU from PROJECT_INSTRUCTIONS.md §9
│   │   ├── PrivateLayout.vue       ← main app layout
│   │   └── PublicLayout.vue
│   └── common/
│       ├── DataTable.vue           ← paginated table with sort + page size selector
│       ├── FilterPanel.vue         ← collapsible filter panel
│       ├── ConfirmDialog.vue
│       ├── LoadingOverlay.vue
│       └── Pagination.vue
├── composables/
│   ├── useAuth.ts                  ← login, logout, isLoggedIn
│   ├── usePagination.ts            ← PaginationState, reset helpers
│   ├── usePermission.ts            ← hasPermission(code: string): boolean
│   └── useToast.ts                 ← success, error, info helpers
├── utils/
│   ├── date.utils.ts               ← format, parse using date-fns
│   ├── string.utils.ts             ← cnpj format, truncate, slugify
│   ├── storage.utils.ts            ← localStorage / sessionStorage typed helpers
│   └── http.utils.ts               ← uploadFile() helper for /upload/* REST calls
└── config/
    └── env.ts                      ← typed env var resolution (import.meta.env.*)
```

---

## Core Patterns

### tRPC client

```typescript
// src/lib/trpc.ts
import { createTRPCProxyClient, httpBatchLink } from '@trpc/client'
import type { AppRouter } from '@osm/api'  // type-only
import { getAccessToken, logout } from './auth'

export const trpcClient = createTRPCProxyClient<AppRouter>({
  links: [
    httpBatchLink({
      url: import.meta.env.VITE_TRPC_URL,
      headers: () => {
        const token = getAccessToken()
        return token ? { Authorization: `Bearer ${token}` } : {}
      },
      fetch: async (url, options) => {
        const res = await fetch(url, options)
        if (res.status === 401) {
          logout()
          window.location.href = '/sign-in?status=expired'
        }
        return res
      },
    }),
  ],
})

// File upload — the only REST call from the frontend
export async function uploadFile(
  path: 'template' | 'validate-variables',
  formData: FormData,
): Promise<Response> {
  const token = getAccessToken()
  return fetch(`${import.meta.env.VITE_UPLOAD_URL}/${path}`, {
    method: 'POST',
    headers: token ? { Authorization: `Bearer ${token}` } : {},
    body: formData,
  })
}
```

### Auth store

```typescript
// src/store/auth.store.ts
import { defineStore } from 'pinia'
import { trpcClient } from '@/lib/trpc'
import { decodeJwt } from 'jose'

interface AuthState {
  accessToken: string | null
  userInfo: { id: string; email: string; fullName: string } | null
  userResources: { _id: string; nome: string; descricao: string }[]
  isLoading: boolean
}

export const useAuthStore = defineStore('auth', {
  state: (): AuthState => ({
    accessToken: localStorage.getItem('access_token'),
    userInfo: null,
    userResources: [],
    isLoading: false,
  }),
  actions: {
    setToken(token: string) {
      this.accessToken = token
      localStorage.setItem('access_token', token)
    },
    logout() {
      this.accessToken = null
      this.userInfo = null
      this.userResources = []
      localStorage.removeItem('access_token')
      sessionStorage.removeItem('recursos')
    },
    isLoggedIn(): boolean {
      if (!this.accessToken) return false
      try {
        const { exp } = decodeJwt(this.accessToken)
        return !!exp && exp * 1000 > Date.now()
      } catch { return false }
    },
    hasPermission(code: string): boolean {
      return this.userResources.some(r => r.nome === code)
    },
    async fetchUserResources() {
      const cached = sessionStorage.getItem('recursos')
      if (cached) {
        try { this.userResources = JSON.parse(atob(cached)); return } catch { /**/ }
      }
      this.userResources = await trpcClient.security.myResources.query()
      sessionStorage.setItem('recursos', btoa(JSON.stringify(this.userResources)))
    },
  },
})
```

### Route guard

```typescript
// src/router/guards.ts
import { useAuthStore } from '@/store/auth.store'

export async function authGuard(to: RouteLocationNormalized) {
  const auth = useAuthStore()

  // Public routes pass through
  if (to.meta.public) return true

  // Not logged in → sign-in
  if (!auth.isLoggedIn()) return { path: '/sign-in', query: { redirect: to.fullPath } }

  // Ensure resources loaded
  if (!auth.userResources.length) await auth.fetchUserResources()

  // Check page-level permission
  const required = to.meta.permission as string | undefined
  if (required && !auth.hasPermission(required)) {
    // Show toast / modal — do NOT redirect to an error page
    return false
  }

  return true
}
```

### Permission guard in templates

```vue
<!-- ✅ Use v-if — never v-show or :disabled for permissions -->
<template>
  <NavItem v-if="hasPermission('MENU_MODELOS')" to="/modelos/dashboard">
    Modelos
  </NavItem>
  <Button v-if="hasPermission('TELA_CONSULTA_MODELO')" @click="openCreate">
    Novo Modelo
  </Button>
</template>

<script setup lang="ts">
const { hasPermission } = usePermission()
</script>
```

### Pagination pattern

```typescript
// src/composables/usePagination.ts
export interface PaginationState {
  page: number   // 0-indexed
  size: number   // 20 | 50 | 100
  sort: string   // "campo,asc" or "campo,desc"
}

export function usePagination(defaultSize = 20) {
  const state = reactive<PaginationState>({ page: 0, size: defaultSize, sort: '' })
  const reset = () => { state.page = 0 }
  const setSort = (field: string) => {
    const [f, dir] = state.sort.split(',')
    state.sort = f === field && dir === 'asc' ? `${field},desc` : `${field},asc`
    reset()
  }
  return { state, reset, setSort }
}
```

### Form pattern (vee-validate + Zod)

```vue
<script setup lang="ts">
import { useForm } from 'vee-validate'
import { toTypedSchema } from '@vee-validate/zod'
import { ModeloDtoSchema } from '@osm/api'

const { handleSubmit, defineField, errors } = useForm({
  validationSchema: toTypedSchema(ModeloDtoSchema),
})

const [nome, nomeAttrs] = defineField('nome')

const onSubmit = handleSubmit(async (values) => {
  await trpcClient.modelos.create.mutate(values)
})
</script>
```

### Analytics service

```typescript
// src/lib/analytics.ts — fire-and-forget, never blocks the UI
class AnalyticsService {
  private queue: any[] = []
  private sessionId = sessionStorage.getItem('analyticsSessionId') ?? crypto.randomUUID()

  init(userId: string) {
    sessionStorage.setItem('analyticsSessionId', this.sessionId)
    this.track({ eventType: 'SESSION_START', userId, page: window.location.pathname })
    setInterval(() => this.flush(), 5000)
    window.addEventListener('beforeunload', () => this.flush())
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') this.flush()
    })
  }

  track(partial: { eventType: string; userId: string; page?: string; [key: string]: unknown }) {
    this.queue.push({ sessionId: this.sessionId, timestamp: new Date().toISOString(),
      page: window.location.pathname, referrer: null, ...partial })
    if (this.queue.length >= 50) this.flush()
  }

  private async flush() {
    if (!this.queue.length) return
    const batch = this.queue.splice(0)
    try {
      await trpcClient.admin.analytics.ingestEvents.mutate({
        events: batch, sessionId: this.sessionId, clientTimestamp: new Date().toISOString(),
      })
    } catch { /* silently drop — analytics must never break the app */ }
  }
}
export const analytics = new AnalyticsService()
```

---

## Admin Layout

The `/admin` section uses a **dedicated sidebar layout** (`AdminLayout.vue`) separate from `PrivateLayout.vue`. The root admin guard checks `SUPER_ADMIN`. Individual sub-pages check their own `ADMIN_*` permission.

```
AdminLayout.vue
└── Sidebar
    ├── Dashboard
    ├── Usuários → Lista / Convites
    ├── Papéis & Permissões → Perfis / Recursos
    ├── Entidades de Suporte (expandable — all 20 types)
    ├── Showroom
    ├── Analytics → Visão Geral / Páginas / Funcionalidades / Usuários / Sessões
    └── Auditoria
```

---

## Storage Keys

```typescript
// localStorage — persists across sessions
// access_token, configs, tiposProduto, tiposExecucao, status, ambientesImplantacao,
// frequenciasExecucao, unidadesNegocio, publicos, finalidades, books, modelos,
// cacheFilter (last model inventory filter), areasProprietaria, perfisPublico,
// bureaus, plataformas, tiposCobranca, gerentesProduto, meiosAcesso, meses,
// detalhesCanal, faturamentos, canais, categories, buckets, showroom

// sessionStorage — cleared on tab close
// recursos (base64 JSON of Recurso[], 4h TTL), userId, analyticsSessionId
```

---

## Rules

1. **No REST calls for domain data** — always use `trpcClient` or TanStack Query + tRPC
2. **v-if not v-show** for permission-gated elements — see `.github/copilot/rules/permission-codes.md`
3. **Types from `@osm/api`** — never define local interfaces that duplicate shared schemas
4. **localStorage cache** — `lista.all` result cached 30 min; `security.myResources` cached 4 h in sessionStorage
5. **Analytics is fire-and-forget** — never `await` analytics calls in user-facing code paths; errors are silently swallowed
