generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ─── Auth & Users ────────────────────────────────────────────────────────────

model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  oktaId       String   @unique
  email        String
  fullName     String
  username     String
  isActive     Boolean  @default(true)
  lastLoginAt  DateTime?
  firstLoginAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  roles        UserRole[]
}

model UserRole {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  roleId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id])
  @@unique([userId, roleId])
}

// ─── RBAC ────────────────────────────────────────────────────────────────────

model Role {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String   @unique
  description   String?
  isActive      Boolean  @default(true)
  parentRoleId  String?  @db.ObjectId
  scope         Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  parentRole    Role?    @relation("RoleHierarchy", fields: [parentRoleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childRoles    Role[]   @relation("RoleHierarchy")
  users         UserRole[]
  permissions   RolePermission[]
}

model Permission {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  code          String   @unique
  resource      String
  action        String
  fieldGroup    String?
  description   String
  module        String
  riskLevel     String?
  category      String?
  isSensitive   Boolean  @default(false)
  isActive      Boolean  @default(true)
  deprecatedAt  DateTime?
  replacedById  String?  @db.ObjectId
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  roles         RolePermission[]
}

model RolePermission {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  roleId       String     @db.ObjectId
  permissionId String     @db.ObjectId
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])
  @@unique([roleId, permissionId])
}

// ─── Client ───────────────────────────────────────────────────────────────────

model Client {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  taxId     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  models    ScoringModel[]
}

// ─── Reference / Lookup (minimal for Phase 2) ──────────────────────────────────

model ModelStatus {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model ProductType {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  color       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model ChargeType {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model ExecutionType {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model ExecutionFrequency {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model Bureau {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model OwnerArea {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model Audience {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model Purpose {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model PublicProfile {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model BusinessUnit {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

model ProductManager {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  models      ScoringModel[]
}

// ─── Scoring Model ────────────────────────────────────────────────────────────

model ScoringModel {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  name                  String
  description           String?
  clientId              String?   @db.ObjectId
  productManagerId      String?   @db.ObjectId
  strategicGroup        String?
  ownerAreaId           String?   @db.ObjectId
  audienceId            String?   @db.ObjectId
  productTypeId         String?   @db.ObjectId
  chargeTypeId          String?   @db.ObjectId
  statusId              String    @db.ObjectId
  startDate             DateTime?
  endDate               DateTime?
  dragonizationDate     DateTime?
  modelAge              Int?
  executionFrequencyId  String?   @db.ObjectId
  executionTypeId       String?   @db.ObjectId
  bureauId              String?   @db.ObjectId
  rangeStart            Int?
  rangeEnd              Int?
  returnsFlag           Boolean   @default(false)
  hasBacktest           Boolean   @default(false)
  isShowroomBizDev      Boolean   @default(false)
  autoExclusion        Boolean   @default(false)
  availableForDelivery  Boolean   @default(false)
  recalibration         Boolean   @default(false)
  clientVariables       Boolean   @default(false)
  highVolume            Boolean   @default(false)
  recurringDeliveries   Boolean   @default(false)
  purposeId             String?   @db.ObjectId
  publicProfileId       String?   @db.ObjectId
  businessUnitId       String?   @db.ObjectId
  appliedFilters        String?
  specificRules         String?
  notes                 String?
  text                  String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String?
  updatedBy             String?

  client                Client?   @relation(fields: [clientId], references: [id])
  status                ModelStatus @relation(fields: [statusId], references: [id])
  productType           ProductType? @relation(fields: [productTypeId], references: [id])
  chargeType            ChargeType? @relation(fields: [chargeTypeId], references: [id])
  executionType         ExecutionType? @relation(fields: [executionTypeId], references: [id])
  executionFrequency    ExecutionFrequency? @relation(fields: [executionFrequencyId], references: [id])
  bureau                Bureau?   @relation(fields: [bureauId], references: [id])
  ownerArea             OwnerArea? @relation(fields: [ownerAreaId], references: [id])
  audience              Audience? @relation(fields: [audienceId], references: [id])
  purpose               Purpose?  @relation(fields: [purposeId], references: [id])
  publicProfile         PublicProfile? @relation(fields: [publicProfileId], references: [id])
  businessUnit          BusinessUnit? @relation(fields: [businessUnitId], references: [id])
  productManager        ProductManager? @relation(fields: [productManagerId], references: [id])
  showroomEntry         ShowroomEntry?
}

// ─── Analytical Solutions ─────────────────────────────────────────────────────

model Category {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  percentage  Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  buckets     Bucket[]
}

model Bucket {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  categoryId  String   @db.ObjectId
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    Category @relation(fields: [categoryId], references: [id])
}

// ─── Showroom ─────────────────────────────────────────────────────────────────

model ShowroomEntry {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  modelId          String   @unique @db.ObjectId
  modelName        String
  modelStatus      String
  addedById        String   @db.ObjectId
  isFeatured       Boolean  @default(false)
  featuredPosition Int?
  addedAt          DateTime @default(now())
  model            ScoringModel @relation(fields: [modelId], references: [id])
}

model ShowroomConfig {
  id               String   @id @default("singleton") @map("_id")
  maxFeatured      Int      @default(5)
  autoSyncFromFlag Boolean  @default(true)
  poolTitle        String   @default("Showroom Pool")
  featuredTitle    String   @default("Featured Models")
  updatedAt        DateTime @updatedAt
  updatedBy        String   @default("system")
}

// ─── Admin ────────────────────────────────────────────────────────────────────

model UserInvitation {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  email       String
  invitedById String   @db.ObjectId
  roleIds     String[] @db.ObjectId
  status      String   @default("PENDING") // PENDING | ACCEPTED | EXPIRED | CANCELLED
  token       String   @unique
  message     String?
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  acceptedAt  DateTime?
}

model AnalyticsEvent {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionId   String
  userId      String
  eventType   String
  page        String?
  referrer    String?
  entityType  String?
  entityId    String?
  featureName String?
  actionLabel String?
  duration    Int?
  loadTime    Int?
  metadata    Json?
  timestamp   DateTime @default(now())
}

// ─── Audit ───────────────────────────────────────────────────────────────────

model AuditLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  actorId     String
  actorName   String
  action      String
  entityType  String
  entityId    String
  entityLabel String
  changes     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  metadata    Json?
}
