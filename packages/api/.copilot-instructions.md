# OSM — @osm/api Package Agent

## Role

You are the **API Package Agent**. You own `packages/api` — the single source of truth for all shared Zod schemas and the tRPC `AppRouter` type. Both `apps/backend` and `apps/frontend` depend on this package. Changes here propagate to both apps at compile time. Work here first, before touching backend or frontend.

---

## Package Info

```
Name:         @osm/api
Path:         packages/api/
Consumed by:  apps/backend (runtime — Zod schemas for input validation)
              apps/frontend (type-only — AppRouter type for tRPC client)
Dependencies: zod ^3.x only — no backend or frontend deps allowed
```

---

## Directory Structure

```
packages/api/
├── src/
│   ├── index.ts                  ← re-exports AppRouter type + all schema exports
│   └── schemas/
│       ├── modelo.schema.ts      ← ModeloDto, FiltroModeloDashboardDto, ModelCommit, ...
│       ├── perfil.schema.ts      ← PerfilDto, Perfil
│       ├── recurso.schema.ts     ← RecursoDto, Recurso
│       ├── categoria.schema.ts   ← CategoryDto, Category
│       ├── balde.schema.ts       ← BucketDto, Bucket
│       ├── faturamento.schema.ts ← FaturamentoDto, Faturamento
│       ├── transacao.schema.ts   ← TransacaoDto, Transacao
│       ├── showroom.schema.ts    ← ShowroomEntry, ShowroomFeatured, ShowroomConfig, ...
│       ├── dashboard.schema.ts   ← DashboardMacroModelo, CustoAwsMensalDto, ...
│       ├── historico.schema.ts   ← HistoricoConsultaItem, DagExecucaoDto
│       ├── lista.schema.ts       ← ConfigsList, LookupEntity, TipoProduto, Book, ...
│       ├── auth.schema.ts        ← UserInfoPayload, AccessTokenPayload
│       └── admin/
│           ├── user.schema.ts    ← User, FiltroUserDto
│           ├── invitation.schema.ts  ← UserInvitation, CreateInvitationDto
│           ├── audit.schema.ts   ← AuditLogEntry, AuditAction, AuditEntityType
│           ├── analytics.schema.ts   ← AnalyticsEvent, AnalyticsEventBatch, report types
│           ├── showroom.schema.ts    ← ShowroomEntry, ShowroomFeatured, ShowroomConfig
│           └── entity.schema.ts  ← SupportEntity, SupportEntityDto, EntityType enum
└── package.json
```

---

## How to Add a New Schema

1. Create `packages/api/src/schemas/<domain>.schema.ts`
2. Define the Zod schema and export the inferred type:

```typescript
// packages/api/src/schemas/exemplo.schema.ts
import { z } from 'zod'

export const ExemploDtoSchema = z.object({
  nome: z.string().min(1),
  descricao: z.string().optional(),
  isActive: z.boolean().default(true),
})

export type ExemploDto = z.infer<typeof ExemploDtoSchema>

export const ExemploSchema = ExemploDtoSchema.extend({
  _id: z.string(),
  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
})

export type Exemplo = z.infer<typeof ExemploSchema>
```

3. Export from `packages/api/src/index.ts`:

```typescript
export * from './schemas/exemplo.schema'
```

---

## Key Schemas (reference — full definitions in PROJECT_INSTRUCTIONS.md §6)

### PaginatedResponse (generic)

```typescript
export const PaginatedResponseSchema = <T extends z.ZodTypeAny>(itemSchema: T) =>
  z.object({
    content: z.array(itemSchema),
    totalElements: z.number(),
    totalPages: z.number(),
    last: z.boolean(),
    first: z.boolean(),
    size: z.number(),
    number: z.number(),          // current page, 0-indexed
    numberOfElements: z.number(),
    empty: z.boolean(),
  })
```

### LookupEntity (base for all 20 reference types)

```typescript
export const LookupEntitySchema = z.object({
  _id: z.string(),
  descricao: z.string(),
})
export type LookupEntity = z.infer<typeof LookupEntitySchema>

// TipoProduto extends with color
export const TipoProdutoSchema = LookupEntitySchema.extend({ color: z.string() })

// Book extends with nome
export const BookSchema = LookupEntitySchema.extend({ nome: z.string() })
```

### EntityType enum (admin.entities generic CRUD)

```typescript
export const EntityTypeSchema = z.enum([
  'status-modelo', 'tipo-produto', 'tipo-execucao', 'tipo-cobranca',
  'frequencia-execucao', 'ambiente-implantacao', 'area-proprietaria',
  'publico', 'bureau', 'plataforma', 'book', 'canal', 'detalhe-canal',
  'pm-responsavel', 'perfil-publico', 'unidade-negocio', 'meio-acesso',
  'meses', 'finalidade', 'cliente',
])
export type EntityType = z.infer<typeof EntityTypeSchema>
```

---

## AppRouter Type Re-export

```typescript
// packages/api/src/index.ts
// Type-only re-export — creates zero runtime dependency on apps/backend
export type { AppRouter } from '../../apps/backend/src/routers/index'

// All schema exports
export * from './schemas/modelo.schema'
export * from './schemas/perfil.schema'
export * from './schemas/recurso.schema'
// ... all other schemas
```

---

## Rules

1. **No runtime deps on apps/backend or apps/frontend** — `package.json` dependencies: `zod` only
2. **Zod schemas are the source of truth** — TypeScript types are always `z.infer<typeof Schema>`, never manually written
3. **One schema file per domain** — do not put multiple unrelated domains in one file
4. **Always export both the schema and the inferred type** — `export const XSchema` + `export type X`
5. **Schemas must match PROJECT_INSTRUCTIONS.md §6 exactly** — do not invent fields
